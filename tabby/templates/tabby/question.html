{% extends "tabby/base.html" %}
{% block title %}
Tabby
{% endblock title %}
{% block css %}
{% load static %}
<link rel="stylesheet" href="{% static "css/question.css" %}">
<link rel="stylesheet" href="{% static "css/qa.css" %}">
<link rel="stylesheet" href="{% static "css/tag.css" %}">
{% endblock css %}
{% block content %}
<div class="container">
    <div class="card">
        <div class="card-body">
            <h1 class="h3 card-title">
            {{ title }}
            </h1>     
            <div style="width: 100%">
                <ul class="tag-list">
                {% for tag in tags %}
                    <li class="tag"><a href="#">{{ tag }}</a></li>
                {% endfor %}
                </ul>
                <div class="q-author">
                    <a href="#"><strong>{{ q_author }}</strong></a>
                    1h ago
                </div>
            </div>
            <p class="card-text">
                {{ description }}
            </p>
        </div>
    </div>
    <div class="card">
        <h1 class="h3 card-header">Answers</h1>
        <div class="card-body">
        {% for ans in ans_list %}
            <article class="ans-item">
                <div class="ans-author">
                    <a href="#"><strong>{{ ans.author }}</strong></a>
                </div>
                <p class="card-text">{{ ans.description }}</p>
                <div class="row">
                    <div class="col-md-2 ans-info">
                        {{ ans.time_diff }}
                    </div>
                    <div class="col-md-1 ans-info">
                        {{ ans.votes }}votes
                    </div>
                    <div class="col-md-2 ans-info user-vote" data-vote-num={{ ans.votes }} data-vote-type={{ ans.cur_user_vote }} data-ansid={{ ans.id }}>
                        <span><a class="vote" data-vote-type=2 href="javascript: void(0)">like</a></span>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <span><a class="vote" data-vote-type=4 href="javascript: void(0)">hate</a></span>
                    </div>
                </div>
                <HR style="FILTER: alpha(opacity=100,finishopacity=0,style=2)" width="100%" color=#987cb9 SIZE=10>
            </article>
        {% endfor %}
        </div>
    </div>
    <div class="card">
    {% if is_authenticated %}
        <h1 class="h3 card-header">Write your answer</h1>
        <div class="card-body">
            <form action="{% url 'tabby:new_answer' %}" method="POST">
                <input type="hidden" name="q_id" value="{{ q_id }}">
                <div class="form-group">
                    <textarea class="form-control" name="ans" rows="10" style="width: 70%;"></textarea>
                </div>
                <button type="submit" class="btn btn-default">submit</button>
            </form>
        </div>
    {% else %}
        <a href="/login">Sign in</a> befor answering
    {% endif %}
    </div>
</div>
{% endblock content %}
{% block scripts %}
<script>
    vote_set = $('.user-vote').toArray()
    for(let i = 0; i < vote_set.length; ++i) {
        changeVoteStyle($(vote_set[i]).parent())
    }

    $('.vote').on('click', function() {
        var parent = $(this).parent().parent()
        var new_vote = parent.data('vote-type')
        var ans_id = parent.data('ansid')
        if($(this).data('vote-type') == 2) {
            new_vote = (new_vote ^ 2) & 3
        }
        else {
            new_vote = (new_vote ^ 4) & 5
        }
        parent.data('vote-type', new_vote)
        $.post('/vote/', {
            'ans_id': ans_id,
            'vote_type': new_vote
        }).done(function(data) {
            parent.data('vote-num', data.vote_num)
            parent.data('vote-type', data.vote_type)
            changeVoteStyle(parent.parent())
        }).always(changeVoteStyle(parent.parent()))
    })

    function changeVoteStyle(e) {
        var vote_num = $(e.children()[2]).data('vote-num')
        var vote_type = $(e.children()[2]).data('vote-type')
        $(e.children()[1]).text(vote_num + 'votes')
        $(e.find('a')[0]).html('like')
        $(e.find('a')[1]).html('hate')
        if(vote_type == 2) {
            $(e.find('a')[0]).html('<strong>like</strong>')
        }
        else if (vote_type == 4) {
            $(e.find('a')[1]).html('<strong>hate</strong>')
        }
    }
</script>
{% endblock scripts %}